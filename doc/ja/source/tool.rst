関連ツール
=====================

``to_dft.py``
******************************

本ツールでは、Si等四面体構造のボンドネットワークを有する系の(001)および(111)表面系モデルについて、
その原子構造から第一原理電子状態計算ソフトウェア `Quantum Espresso (QE) <https://www.quantum-espresso.org/>`_ 用の入力データを作成する。これにより、得られた構造の妥当性検証や、電子状態等の微視的な情報を取得する。
なお、注目する表面と反対の表面から生じるダングリングボンド由来の電子の影響を排除するため、最下層のダングリングボンドの位置に水素原子を置く水素終端というテクニックを用いている。


必要な環境
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Python3

また、以下のパッケージが必要である。

- `Atomic Simulation Environment(ASE) <https://wiki.fysik.dtu.dk/ase>`_
- Numpy
- Scipy
- Matplotlib
  
スクリプトの概要
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

XYZ形式と2次元的な周期構造を表すための格子ベクトルの情報などが記載された入力ファイルを読み込み、得られた座標データから、最下層と、その次の層にあたる原子の座標を抽出する。
最下層の原子は取り除き、対応する位置に H 原子を置いて次層の原子との距離を四面体構造となる距離(例えば、Siの場合はシラン分子となる距離)に調整したモデルを作成する。
水素終端を行ったモデルはXYZ形式で保存される。
また、ASEの機能を利用し、cifファイルとQEの入力ファイルも作成する。

チュートリアル
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. 実行時の引数として元となる(行末に二次元格子ベクトルのデータを含んだ)XYZファイルを渡す。
以下では、 ``tool/todft/sample`` フォルダにある ``surf_bulk_new111.xyz`` を用いる。
ファイルの中身は以下の通りである。

.. code-block::

   12
    surf.txt             / bulk.txt
    Si    1.219476    0.000000    4.264930
    Si    6.459844    0.000000    4.987850
    Si    1.800417    1.919830    3.404650
    Si    5.878903    1.919830    3.404650
    Si    3.839660    1.919830    2.155740
    Si    0.000000    1.919830    1.900440
    Si    3.839660    0.000000    0.743910
    Si    0.000000    0.000000    0.597210
    Si    1.919830    0.000000   -0.678750
    Si    5.759490    0.000000   -0.678750
    Si    1.919830    1.919830   -2.036250
    Si    5.759490    1.919830   -2.036250

2. 次に各種パラメータを設定するための入力ファイルを作成する。
入力ファイルのファイル形式は ``toml`` である。以下では、 ``tool/todft/sample`` フォルダにある ``input.toml`` を用いて、その内容について説明する。ファイルの中身は以下の通りである。

.. code-block::

   [Main]
   input_xyz_file = "surf_bulk_new111.xyz"
   output_file_head = "surf_bulk_new111_ext"
   [Main.param]
   z_margin = 0.001
   slab_margin = 10.0
   r_SiH = 1.48 #angstrom
   theta = 109.5 #H-Si-H angle in degree
   [Main.lattice]
   unit_vec = [[7.67932, 0.00000, 0.00000], [0.00000, 3.83966, 0.00000]]
   [ASE]
   solver_name = "qe"
   kpts = [3,3,1]        # sampling k points (Monkhorst-Pack grid)
   command = "mpirun -np 4 ./pw.x -in espresso.pwi > espresso.pwo"
   [Solver]
   [Solver.control]
   calculation='bands' # 'scf','realx','bands',...
   pseudo_dir='./'     # Pseudopotential directory
   [Solver.system]
   ecutwfc = 20.0        # Cut-off energy in Ry
   nbands=33           # # of bands (only used in band structure calc
   [Solver.pseudo]
   Si = 'Si.pbe-mt_fhi.UPF'
   H = 'H.pbe-mt_fhi.UPF'

入力ファイルは、 ``Main`` , ``ASE`` , ``Solver`` の3セクションから構成される。
以下、各セクション毎に変数の説明を簡単に記載する。

``Main`` セクション
------------------------
このセクションでは、水素終端を行う際に必要なパラメータに関する設定を行う。

- ``input_xyz_file``
  
  形式: string型

  説明：入力するxyzファイルの名前

- ``output_file_head``

  形式: string型

  説明：出力ファイル(xyzファイルおよびcifファイル)につくヘッダ。

``Main.Param`` セクション
-----------------------------

- ``z_margin``

  形式: float型

  説明: 最下層および下から2番目の原子を抽出する際に用いられるマージン。例えば、最下層にいる原子のz座標を ``z_min`` とした場合に、 ``z_min - z_margin <= z <= z_min + z_margin`` の中にいる原子が抽出される。

- ``slab_margin``

  形式: float型

  説明: スラブの大きさに下駄をはかせるためのマージン。最下層および一番上の層にいる原子のz座標を ``z_min`` , ``z_max`` とした場合に、スラブの大きさは ``z_max-z_min+slab_margin`` で与えられる。
  
- ``r_SiH``

  形式： float型

  説明： SiとH間の距離を与える(単位はオームストロング)。
  
- ``theta``

  形式： float型

  説明： H-Si-H間の角度を与える。

``ASE`` セクション
------------------------
このセクションでは、 ``ASE`` に関連したパラメータを設定する。

- ``solver_name``

  形式： string型

  説明： ソルバーの名前を与える。現状では ``qe`` のみ。

- ``kpts``

  形式： list型

  説明： サンプリングするkポイントを指定する(Monkhorst-Pack grid)。

- ``command``

  形式： str型

  説明： ソルバーを実行するときのコマンドを記載する。

``Solver`` セクション
------------------------
このセクションでは、 ``Solver`` に関連したパラメータを設定する。
基本的には各ソルバーの入力ファイルで指定したものと同じ構成で記載する。
例えば、Quantum Espressoの場合には ``Solver.control`` で、
``control`` セクションで設定したパラメータに関して設定する。
そのため、詳細については割愛する。

  
3. 以下のコマンドを実行する。

.. code-block::

    python3 to_dft.py input.toml


これを実行すると、

- ``surf_bulk_new111_ext.xyz``
- ``surf_bulk_new111_ext.cif``
- ``espresso.pwi``
  
が生成される。 以下、順に出力ファイルについて説明する。

- ``surf_bulk_new111_ext.xyz``

最下層原子のHへの置換と四面体構造を形成するためのHの追加が行われた結果が出力される。

.. code-block::

    14
    Lattice="7.67932 0.0 0.0  0.0 3.83966 0.0  0.0 0.0 17.0241" Properties=species:S:1:pos:R:3 pbc="T T T"
    Si  1.219476  0.000000  4.264930
    Si  6.459844  0.000000  4.987850
    Si  1.800417  1.919830  3.404650
    Si  5.878903  1.919830  3.404650
    Si  3.839660  1.919830  2.155740
    Si  0.000000  1.919830  1.900440
    Si  3.839660  0.000000  0.743910
    Si  0.000000  0.000000  0.597210
    Si  1.919830  0.000000  -0.678750
    Si  5.759490  0.000000  -0.678750
    H  1.919830  -1.208630  -1.532925
    H  1.919830  1.208630  -1.532925
    H  5.759490  -1.208630  -1.532925
    H  5.759490  1.208630  -1.532925

このファイルは通常のXYZ形式の座標データとして適当な可視化ソフト等に読ませることができるが、通常コメントを書く場所に周期構造の格子ベクトルの情報が書き込まれている。
出力されたファイルの3行目以降の「元素名+3次元座標」のデータをそのままQEの入力ファイルにコピーして使用する事もできる。

``espresso.pwi`` はQEのscf計算用の入力ファイルであり、
構造最適化やバンド計算は本ファイルを適宜修正することで行うことができる。
各種設定については `QEのオンラインマニュアル <https://www.quantum-espresso.org/Doc/INPUT_PW.html>`_ を参考のこと。
